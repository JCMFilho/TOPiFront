import { __assign, __decorate, __metadata, __param, __read, __spread } from "tslib";
import { Component, Input, Output, EventEmitter, ChangeDetectionStrategy, OnChanges, TemplateRef, OnDestroy, ViewChildren, QueryList, SimpleChanges, ContentChild, ViewChild, NgZone, ElementRef, ChangeDetectorRef, Optional, Inject } from '@angular/core';
import { ActiveDescendantKeyManager } from '@angular/cdk/a11y';
import { CdkOverlayOrigin, CdkConnectedOverlay } from '@angular/cdk/overlay';
import { take } from 'rxjs/operators';
import { DEFAULT_DROPDOWN_POSITIONS } from '../util/overlay-position';
import { uniqueId, isOptionSelected, addOptionToSelection } from '../util/util';
import { InputBoolean, InputNumber } from '../util/convert';
import { NglComboboxOption } from './combobox-option';
import { NglComboboxInput } from './combobox-input';
import { NglComboboxService } from './combobox.service';
import { NglComboboxConfig, NGL_COMBOBOX_CONFIG } from './config';
var NglCombobox = /** @class */ (function () {
    function NglCombobox(defaultConfig, ngZone, cd, service) {
        var _this = this;
        this.ngZone = ngZone;
        this.cd = cd;
        this.service = service;
        this.variant = 'base';
        this.uid = uniqueId('combobox');
        this.open = false;
        this.openChange = new EventEmitter();
        this.selectionChange = new EventEmitter();
        this.multiple = false;
        this.visibleLength = 5;
        this.closeOnSelection = true;
        this.overlayWidth = 0;
        this.overlayPositions = __spread(DEFAULT_DROPDOWN_POSITIONS['left']);
        this.selectionValueFn = function (selection) {
            if (selection.length > 0) {
                if (_this.multiple && _this.isLookup) {
                    return '';
                }
                return selection.length === 1 ? selection[0] : selection.length + " options selected";
            }
            return '';
        };
        var config = __assign(__assign({}, new NglComboboxConfig()), defaultConfig);
        this.loadingLabel = config.loadingLabel;
        this.noOptionsFound = config.noOptionsFound;
        this.removeSelectedLabel = config.removeSelectedLabel;
        this.service.combobox = this;
        // this.service.openChange = this.openChange;
    }
    Object.defineProperty(NglCombobox.prototype, "data", {
        get: function () {
            return this._data;
        },
        set: function (data) {
            this._data = (data || []).map(function (d) {
                if (typeof d === 'string') {
                    // Support array of strings as options, by mapping to NglComboboxOptionItem
                    return { value: d, label: d };
                }
                else if (!d.label) {
                    // Use `value` if missing `label`
                    return __assign(__assign({}, d), { label: d.value });
                }
                return d;
            });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NglCombobox.prototype, "activeOption", {
        get: function () {
            return this.keyManager ? this.keyManager.activeItem : null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NglCombobox.prototype, "selectedOptions", {
        get: function () {
            var _this = this;
            return this.data ? this.data.filter(function (d) { return _this.isSelected(d.value); }) : [];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NglCombobox.prototype, "isLookup", {
        get: function () {
            return this.variant === 'lookup';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NglCombobox.prototype, "hasLookupSingleSelection", {
        get: function () {
            return this.isLookup && !this.multiple && this.selectedOptions.length > 0;
        },
        enumerable: true,
        configurable: true
    });
    NglCombobox.prototype.ngOnChanges = function (changes) {
        if (changes.selection) {
            this.calculateDisplayValue();
        }
    };
    NglCombobox.prototype.onAttach = function () {
        var _this = this;
        // Same width as the trigger element
        this.overlayWidth = this.overlayOrigin.elementRef.nativeElement.offsetWidth;
        this.cd.detectChanges();
        this.keyManager = new ActiveDescendantKeyManager(this.options).withWrap();
        // Activate selected item or first option
        var selectedOption = this.options.find(function (o) { return o.selected; });
        if (selectedOption) {
            this.keyManager.setActiveItem(selectedOption);
        }
        else {
            this.keyManager.setFirstItemActive();
        }
        // Listen to button presses if picklist to activate matching option
        this.keyboardSubscribe(this.variant === 'base');
        // When it is open we listen for option changes in order to fix active option and handle scroll
        this.optionChangesSubscription = this.options.changes.subscribe(function () {
            if (!_this.activeOption || _this.options.toArray().indexOf(_this.activeOption) === -1) {
                // Activate first option if active one is destroyed
                _this.keyManager.setFirstItemActive();
            }
            else {
                _this.activeOption.scrollIntoView();
            }
            _this.updateMenuHeight();
        });
        this.updateMenuHeight();
    };
    NglCombobox.prototype.onDetach = function () {
        if (this.open) {
            this.close();
            return;
        }
        // Clear aria-activedescendant when menu is closed
        this.inputEl.setAriaActiveDescendant(null);
        this.detach();
    };
    NglCombobox.prototype.trackByOption = function (index, option) {
        return option.value;
    };
    NglCombobox.prototype.dropdownClass = function () {
        var _a;
        return _a = {},
            _a["slds-dropdown_length-" + this.visibleLength] = this.visibleLength > 0,
            _a;
    };
    NglCombobox.prototype.inputIconRight = function () {
        return this.isLookup ? 'utility:search' : 'utility:down';
    };
    NglCombobox.prototype.hasNoMatches = function () {
        return this.isLookup && this.data.length === 0 && !this.loadingMore;
    };
    NglCombobox.prototype.onOptionSelection = function (option) {
        if (option === void 0) { option = this.activeOption; }
        var selection = addOptionToSelection(option.value, this.selection, this.multiple);
        this.selectionChange.emit(selection);
        if (this.closeOnSelection) {
            this.close();
        }
    };
    // Trigger by clear button on Lookup
    NglCombobox.prototype.onClearSelection = function () {
        var _this = this;
        this.selectionChange.emit(null);
        setTimeout(function () { return _this.inputEl.focus(); }, 0);
    };
    /**
     * Check whether value is currently selected.
     *
     * @param value The value in test, whether is (part of) selection or not
     */
    NglCombobox.prototype.isSelected = function (value) {
        return isOptionSelected(value, this.selection, this.multiple);
    };
    NglCombobox.prototype.ngOnDestroy = function () {
        this.detach();
    };
    NglCombobox.prototype.close = function () {
        this.openChange.emit(false);
    };
    NglCombobox.prototype.detach = function () {
        this.keyboardSubscribe(false);
        this.keyManager = null;
        if (this.optionChangesSubscription) {
            this.optionChangesSubscription.unsubscribe();
            this.optionChangesSubscription = null;
        }
    };
    NglCombobox.prototype.calculateDisplayValue = function () {
        var value = this.selectionValueFn(this.selectedOptions.map(function (option) { return option.label; }));
        this.inputEl.setValue(value);
    };
    NglCombobox.prototype.keyboardSubscribe = function (listen) {
        var _this = this;
        if (this.keyboardSubscription) {
            this.keyboardSubscription.unsubscribe();
            this.keyboardSubscription = null;
        }
        if (listen) {
            this.keyboardSubscription = this.inputEl.keyboardBuffer$.subscribe(function (pattern) {
                pattern = pattern.toLocaleLowerCase();
                var options = _this.options.toArray();
                var activeIndex = _this.activeOption ? _this.keyManager.activeItemIndex + 1 : 0;
                for (var i = 0, n = options.length; i < n; i++) {
                    var index = (activeIndex + i) % n;
                    var option = options[index];
                    if (!option.disabled && option.label.toLocaleLowerCase().substr(0, pattern.length) === pattern) {
                        _this.keyManager.setActiveItem(option);
                        break;
                    }
                }
            });
        }
    };
    NglCombobox.prototype.updateMenuHeight = function () {
        var _this = this;
        this.ngZone.onStable.asObservable().pipe(take(1)).subscribe(function () {
            var overlayRef = _this.cdkOverlay.overlayRef;
            var height = _this.dropdownElementRef.nativeElement.offsetHeight;
            overlayRef.updateSize({
                minHeight: height + 4,
            });
            overlayRef.updatePosition();
        });
    };
    NglCombobox.ctorParameters = function () { return [
        { type: NglComboboxConfig, decorators: [{ type: Optional }, { type: Inject, args: [NGL_COMBOBOX_CONFIG,] }] },
        { type: NgZone },
        { type: ChangeDetectorRef },
        { type: NglComboboxService }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], NglCombobox.prototype, "variant", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglCombobox.prototype, "label", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Object)
    ], NglCombobox.prototype, "open", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], NglCombobox.prototype, "openChange", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglCombobox.prototype, "selection", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], NglCombobox.prototype, "selectionChange", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Object)
    ], NglCombobox.prototype, "multiple", void 0);
    __decorate([
        Input(), InputNumber(),
        __metadata("design:type", Number)
    ], NglCombobox.prototype, "visibleLength", void 0);
    __decorate([
        ContentChild(NglComboboxInput, { static: true }),
        __metadata("design:type", NglComboboxInput)
    ], NglCombobox.prototype, "inputEl", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Boolean)
    ], NglCombobox.prototype, "loading", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Boolean)
    ], NglCombobox.prototype, "loadingMore", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Object)
    ], NglCombobox.prototype, "closeOnSelection", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], NglCombobox.prototype, "loadingLabel", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], NglCombobox.prototype, "noOptionsFound", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], NglCombobox.prototype, "removeSelectedLabel", void 0);
    __decorate([
        ViewChildren(NglComboboxOption),
        __metadata("design:type", QueryList)
    ], NglCombobox.prototype, "options", void 0);
    __decorate([
        Input('options'),
        __metadata("design:type", Array),
        __metadata("design:paramtypes", [Array])
    ], NglCombobox.prototype, "data", null);
    __decorate([
        ViewChild('overlayOrigin', { static: true }),
        __metadata("design:type", CdkOverlayOrigin)
    ], NglCombobox.prototype, "overlayOrigin", void 0);
    __decorate([
        ViewChild('cdkOverlay'),
        __metadata("design:type", CdkConnectedOverlay)
    ], NglCombobox.prototype, "cdkOverlay", void 0);
    __decorate([
        ViewChild('dropdown'),
        __metadata("design:type", ElementRef)
    ], NglCombobox.prototype, "dropdownElementRef", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglCombobox.prototype, "selectionValueFn", void 0);
    NglCombobox = __decorate([
        Component({
            selector: 'ngl-combobox',
            changeDetection: ChangeDetectionStrategy.OnPush,
            template: "\n<label [nglFormLabel]=\"label\" [attr.for]=\"inputEl.id\"></label>\n<div class=\"slds-form-element__control\">\n  <div class=\"slds-combobox_container\" [class.slds-has-selection]=\"hasLookupSingleSelection\">\n    <div class=\"slds-combobox slds-dropdown-trigger slds-dropdown-trigger_click\" [attr.aria-expanded]=\"open\" aria-haspopup=\"listbox\" role=\"combobox\" [class.slds-is-open]=\"open\" [attr.aria-owns]=\"uid\">\n      <div class=\"slds-combobox__form-element slds-input-has-icon\" role=\"none\" cdkOverlayOrigin #overlayOrigin=\"cdkOverlayOrigin\" [class.slds-input-has-icon_group-right]=\"loading\" [class.slds-input-has-icon_right]=\"!loading\">\n        <ng-content select=\"input\"></ng-content>\n        <div class=\"slds-input__icon-group slds-input__icon-group_right\" *ngIf=\"loading; else iconRight\">\n          <div class=\"slds-spinner slds-spinner_brand slds-spinner_x-small slds-input__spinner\" role=\"status\"><span class=\"slds-assistive-text\">{{ loadingLabel }}</span>\n            <div class=\"slds-spinner__dot-a\"></div>\n            <div class=\"slds-spinner__dot-b\"></div>\n          </div>\n          <ng-template [ngTemplateOutlet]=\"iconRight\"></ng-template>\n        </div>\n        <ng-template #iconRight>\n          <button class=\"slds-button slds-button_icon slds-input__icon slds-input__icon_right\" *ngIf=\"hasLookupSingleSelection; else iconTpl\" type=\"button\" (click)=\"onClearSelection()\" [title]=\"removeSelectedLabel\">\n            <svg class=\"slds-button__icon\" nglIconName=\"utility:close\"></svg><span class=\"slds-assistive-text\">{{ removeSelectedLabel }}</span>\n          </button>\n        </ng-template>\n        <ng-template #iconTpl><span class=\"slds-icon_container slds-input__icon slds-input__icon_right\">\n            <svg class=\"slds-icon slds-icon_x-small slds-icon-text-default\" [nglIconName]=\"inputIconRight()\"></svg></span></ng-template>\n      </div>\n    </div>\n  </div>\n</div>\n<ng-template cdkConnectedOverlay #cdkOverlay=\"cdkConnectedOverlay\" [cdkConnectedOverlayPositions]=\"overlayPositions\" [cdkConnectedOverlayOrigin]=\"overlayOrigin\" [cdkConnectedOverlayMinWidth]=\"overlayWidth\" [cdkConnectedOverlayOpen]=\"open\" (nglOverlayScrolledOutsideView)=\"close()\" (attach)=\"onAttach()\" (detach)=\"onDetach()\">\n  <div class=\"slds-dropdown slds-dropdown_fluid\" #dropdown [attr.id]=\"uid\" role=\"listbox\" [ngClass]=\"dropdownClass()\" (mousedown)=\"$event.preventDefault()\">\n    <ul class=\"slds-listbox slds-listbox_vertical\" role=\"presentation\">\n      <li *ngFor=\"let d of data; trackBy: trackByOption\" nglComboboxOption [value]=\"d.value\" [label]=\"d.label\" [disabled]=\"d.disabled\" [selected]=\"isSelected(d.value)\"></li>\n      <li class=\"slds-listbox__item\" *ngIf=\"loadingMore\" role=\"presentation\">\n        <div class=\"slds-align_absolute-center slds-p-top_medium\">\n          <div class=\"slds-spinner slds-spinner_x-small slds-spinner_inline\" role=\"status\">\n            <div class=\"slds-assistive-text\">{{ loadingLabel }}</div>\n            <div class=\"slds-spinner__dot-a\"></div>\n            <div class=\"slds-spinner__dot-b\"></div>\n          </div>\n        </div>\n      </li>\n      <li class=\"slds-listbox__item\" *ngIf=\"hasNoMatches()\" role=\"presentation\" aria-live=\"polite\">\n        <div class=\"slds-align_absolute-center\"><span role=\"status\">{{ noOptionsFound }}</span></div>\n      </li>\n    </ul>\n  </div>\n</ng-template>",
            host: {
                'class.slds-form-element': 'true',
            },
            providers: [NglComboboxService]
        }),
        __param(0, Optional()), __param(0, Inject(NGL_COMBOBOX_CONFIG)),
        __metadata("design:paramtypes", [NglComboboxConfig,
            NgZone,
            ChangeDetectorRef,
            NglComboboxService])
    ], NglCombobox);
    return NglCombobox;
}());
export { NglCombobox };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tYm9ib3guanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvY29tYm9ib3hlcy9jb21ib2JveC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSx1QkFBdUIsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFDbEcsWUFBWSxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekosT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDL0QsT0FBTyxFQUEwQixnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXJHLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0QyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFLG9CQUFvQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ2hGLE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDcEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLG1CQUFtQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBaUJsRTtJQTBHRSxxQkFBcUQsYUFBZ0MsRUFDakUsTUFBYyxFQUNkLEVBQXFCLEVBQ3JC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QUF1QixDQUFDLE1BQU07WUFDL0MsODZHQUE4QjtZQUM5QixJQUFJLEVBQUU7Z0JBQ0oseUJBQXlCLEVBQUUsTUFBTTthQUNsQztZQUNELFNBQVMsRUFBRSxDQUFFLGtCQUFrQixDQUFFO1NBQ2xDLENBQUM7UUEyR2EsV0FBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLFdBQUEsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUE7eUNBQWdCLGlCQUFpQjtZQUN6RCxNQUFNO1lBQ1YsaUJBQWlCO1lBQ1osa0JBQWtCO09BN0dwQyxXQUFXLENBNFF2QjtJQUFELGtCQUFDO0NBQUEsQUE1UUQsSUE0UUM7U0E1UVksV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgT25DaGFuZ2VzLCBUZW1wbGF0ZVJlZiwgT25EZXN0cm95LFxuICAgICAgICAgVmlld0NoaWxkcmVuLCBRdWVyeUxpc3QsIFNpbXBsZUNoYW5nZXMsIENvbnRlbnRDaGlsZCwgVmlld0NoaWxkLCBOZ1pvbmUsIEVsZW1lbnRSZWYsIENoYW5nZURldGVjdG9yUmVmLCBPcHRpb25hbCwgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmVEZXNjZW5kYW50S2V5TWFuYWdlciB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9hMTF5JztcbmltcG9ydCB7IENvbm5lY3Rpb25Qb3NpdGlvblBhaXIsIENka092ZXJsYXlPcmlnaW4sIENka0Nvbm5lY3RlZE92ZXJsYXkgfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBERUZBVUxUX0RST1BET1dOX1BPU0lUSU9OUyB9IGZyb20gJy4uL3V0aWwvb3ZlcmxheS1wb3NpdGlvbic7XG5pbXBvcnQgeyB1bmlxdWVJZCwgaXNPcHRpb25TZWxlY3RlZCwgYWRkT3B0aW9uVG9TZWxlY3Rpb24gfSBmcm9tICcuLi91dGlsL3V0aWwnO1xuaW1wb3J0IHsgSW5wdXRCb29sZWFuLCBJbnB1dE51bWJlciB9IGZyb20gJy4uL3V0aWwvY29udmVydCc7XG5pbXBvcnQgeyBOZ2xDb21ib2JveE9wdGlvbiB9IGZyb20gJy4vY29tYm9ib3gtb3B0aW9uJztcbmltcG9ydCB7IE5nbENvbWJvYm94SW5wdXQgfSBmcm9tICcuL2NvbWJvYm94LWlucHV0JztcbmltcG9ydCB7IE5nbENvbWJvYm94U2VydmljZSB9IGZyb20gJy4vY29tYm9ib3guc2VydmljZSc7XG5pbXBvcnQgeyBOZ2xDb21ib2JveENvbmZpZywgTkdMX0NPTUJPQk9YX0NPTkZJRyB9IGZyb20gJy4vY29uZmlnJztcblxuZXhwb3J0IGludGVyZmFjZSBOZ2xDb21ib2JveE9wdGlvbkl0ZW0ge1xuICB2YWx1ZTogbnVtYmVyIHwgc3RyaW5nO1xuICBsYWJlbD86IHN0cmluZztcbiAgZGlzYWJsZWQ/OiBib29sZWFuO1xufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ2wtY29tYm9ib3gnLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgdGVtcGxhdGVVcmw6ICcuL2NvbWJvYm94Lmh0bWwnLFxuICBob3N0OiB7XG4gICAgJ2NsYXNzLnNsZHMtZm9ybS1lbGVtZW50JzogJ3RydWUnLFxuICB9LFxuICBwcm92aWRlcnM6IFsgTmdsQ29tYm9ib3hTZXJ2aWNlIF0sXG59KVxuZXhwb3J0IGNsYXNzIE5nbENvbWJvYm94IGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuXG4gIEBJbnB1dCgpIHJlYWRvbmx5IHZhcmlhbnQ6ICdiYXNlJyB8ICdsb29rdXAnID0gJ2Jhc2UnO1xuXG4gIEBJbnB1dCgpIHJlYWRvbmx5IGxhYmVsOiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+O1xuXG4gIHJlYWRvbmx5IHVpZCA9IHVuaXF1ZUlkKCdjb21ib2JveCcpO1xuXG4gIEBJbnB1dCgpIEBJbnB1dEJvb2xlYW4oKSByZWFkb25seSBvcGVuID0gZmFsc2U7XG5cbiAgQE91dHB1dCgpIG9wZW5DaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XG5cbiAgQElucHV0KCkgcmVhZG9ubHkgc2VsZWN0aW9uOiBhbnk7XG5cbiAgQE91dHB1dCgpIHNlbGVjdGlvbkNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBASW5wdXQoKSBASW5wdXRCb29sZWFuKCkgcmVhZG9ubHkgbXVsdGlwbGUgPSBmYWxzZTtcblxuICBASW5wdXQoKSBASW5wdXROdW1iZXIoKSByZWFkb25seSB2aXNpYmxlTGVuZ3RoOiA1IHwgNyB8IDEwID0gNTtcblxuICBAQ29udGVudENoaWxkKE5nbENvbWJvYm94SW5wdXQsIHsgc3RhdGljOiB0cnVlIH0pIGlucHV0RWw6IE5nbENvbWJvYm94SW5wdXQ7XG5cbiAgQElucHV0KCkgQElucHV0Qm9vbGVhbigpIHJlYWRvbmx5IGxvYWRpbmc6IGJvb2xlYW47XG5cbiAgQElucHV0KCkgQElucHV0Qm9vbGVhbigpIHJlYWRvbmx5IGxvYWRpbmdNb3JlOiBib29sZWFuO1xuXG4gIEBJbnB1dCgpIEBJbnB1dEJvb2xlYW4oKSByZWFkb25seSBjbG9zZU9uU2VsZWN0aW9uID0gdHJ1ZTtcblxuICAvKipcbiAgICogVGV4dCBhZGRlZCB0byBsb2FkaW5nIHNwaW5uZXIuXG4gICAqL1xuICBASW5wdXQoKSBsb2FkaW5nTGFiZWw6IHN0cmluZztcblxuICAvKipcbiAgICogVGV4dCBtZXNzYWdlIHRoYXQgcmVuZGVycyB3aGVuIG5vIG1hdGNoZXMgZm91bmQuXG4gICAqL1xuICBASW5wdXQoKSBub09wdGlvbnNGb3VuZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUZXh0IGZvciByZW1vdmluZyBzaW5nbGUgc2VsZWN0ZWQgb3B0aW9uLlxuICAgKi9cbiAgQElucHV0KCkgcmVtb3ZlU2VsZWN0ZWRMYWJlbDogc3RyaW5nO1xuXG4gIEBWaWV3Q2hpbGRyZW4oTmdsQ29tYm9ib3hPcHRpb24pIHJlYWRvbmx5IG9wdGlvbnM6IFF1ZXJ5TGlzdDxOZ2xDb21ib2JveE9wdGlvbj47XG5cbiAgQElucHV0KCdvcHRpb25zJykgc2V0IGRhdGEoZGF0YTogYW55W10pIHtcbiAgICB0aGlzLl9kYXRhID0gKGRhdGEgfHwgW10pLm1hcCgoZCkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBkID09PSAnc3RyaW5nJykge1xuICAgICAgICAvLyBTdXBwb3J0IGFycmF5IG9mIHN0cmluZ3MgYXMgb3B0aW9ucywgYnkgbWFwcGluZyB0byBOZ2xDb21ib2JveE9wdGlvbkl0ZW1cbiAgICAgICAgcmV0dXJuIHsgdmFsdWU6IGQsIGxhYmVsOiBkIH07XG4gICAgICB9IGVsc2UgaWYgKCFkLmxhYmVsKSB7XG4gICAgICAgIC8vIFVzZSBgdmFsdWVgIGlmIG1pc3NpbmcgYGxhYmVsYFxuICAgICAgICByZXR1cm4geyAuLi5kLCBsYWJlbDogZC52YWx1ZSB9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIGQ7XG4gICAgfSk7XG4gIH1cbiAgZ2V0IGRhdGEoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGE7XG4gIH1cblxuICBAVmlld0NoaWxkKCdvdmVybGF5T3JpZ2luJywgeyBzdGF0aWM6IHRydWUgfSkgb3ZlcmxheU9yaWdpbjogQ2RrT3ZlcmxheU9yaWdpbjtcblxuICBAVmlld0NoaWxkKCdjZGtPdmVybGF5JykgY2RrT3ZlcmxheTogQ2RrQ29ubmVjdGVkT3ZlcmxheTtcblxuICBAVmlld0NoaWxkKCdkcm9wZG93bicpIGRyb3Bkb3duRWxlbWVudFJlZjogRWxlbWVudFJlZjtcblxuICBvdmVybGF5V2lkdGggPSAwO1xuXG4gIG92ZXJsYXlQb3NpdGlvbnM6IENvbm5lY3Rpb25Qb3NpdGlvblBhaXJbXSA9IFsuLi5ERUZBVUxUX0RST1BET1dOX1BPU0lUSU9OU1snbGVmdCddXTtcblxuICAvKiogTWFuYWdlcyBhY3RpdmUgaXRlbSBpbiBvcHRpb24gbGlzdCBiYXNlZCBvbiBrZXkgZXZlbnRzLiAqL1xuICBrZXlNYW5hZ2VyOiBBY3RpdmVEZXNjZW5kYW50S2V5TWFuYWdlcjxOZ2xDb21ib2JveE9wdGlvbj47XG5cbiAgcHJpdmF0ZSBvcHRpb25DaGFuZ2VzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgcHJpdmF0ZSBfZGF0YTogTmdsQ29tYm9ib3hPcHRpb25JdGVtW10gfCBudWxsO1xuXG4gIHByaXZhdGUga2V5Ym9hcmRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBASW5wdXQoKSBzZWxlY3Rpb25WYWx1ZUZuID0gKHNlbGVjdGlvbjogc3RyaW5nW10pOiBzdHJpbmcgPT4ge1xuICAgIGlmIChzZWxlY3Rpb24ubGVuZ3RoID4gMCkge1xuICAgICAgaWYgKHRoaXMubXVsdGlwbGUgJiYgdGhpcy5pc0xvb2t1cCkge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgICB9XG4gICAgICByZXR1cm4gc2VsZWN0aW9uLmxlbmd0aCA9PT0gMSA/IHNlbGVjdGlvblswXSA6IGAke3NlbGVjdGlvbi5sZW5ndGh9IG9wdGlvbnMgc2VsZWN0ZWRgO1xuICAgIH1cbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBnZXQgYWN0aXZlT3B0aW9uKCk6IE5nbENvbWJvYm94T3B0aW9uIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMua2V5TWFuYWdlciA/IHRoaXMua2V5TWFuYWdlci5hY3RpdmVJdGVtIDogbnVsbDtcbiAgfVxuXG4gIGdldCBzZWxlY3RlZE9wdGlvbnMoKTogTmdsQ29tYm9ib3hPcHRpb25JdGVtW10ge1xuICAgIHJldHVybiB0aGlzLmRhdGEgPyB0aGlzLmRhdGEuZmlsdGVyKGQgPT4gdGhpcy5pc1NlbGVjdGVkKGQudmFsdWUpKSA6IFtdO1xuICB9XG5cbiAgZ2V0IGlzTG9va3VwKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnZhcmlhbnQgPT09ICdsb29rdXAnO1xuICB9XG5cbiAgZ2V0IGhhc0xvb2t1cFNpbmdsZVNlbGVjdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5pc0xvb2t1cCAmJiAhdGhpcy5tdWx0aXBsZSAmJiB0aGlzLnNlbGVjdGVkT3B0aW9ucy5sZW5ndGggPiAwO1xuICB9XG5cbiAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgQEluamVjdChOR0xfQ09NQk9CT1hfQ09ORklHKSBkZWZhdWx0Q29uZmlnOiBOZ2xDb21ib2JveENvbmZpZyxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBjZDogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgICAgICAgICAgIHByaXZhdGUgc2VydmljZTogTmdsQ29tYm9ib3hTZXJ2aWNlKSB7XG4gICAgY29uc3QgY29uZmlnID0geyAuLi5uZXcgTmdsQ29tYm9ib3hDb25maWcoKSwgLi4uZGVmYXVsdENvbmZpZyB9O1xuICAgIHRoaXMubG9hZGluZ0xhYmVsID0gY29uZmlnLmxvYWRpbmdMYWJlbDtcbiAgICB0aGlzLm5vT3B0aW9uc0ZvdW5kID0gY29uZmlnLm5vT3B0aW9uc0ZvdW5kO1xuICAgIHRoaXMucmVtb3ZlU2VsZWN0ZWRMYWJlbCA9IGNvbmZpZy5yZW1vdmVTZWxlY3RlZExhYmVsO1xuXG4gICAgdGhpcy5zZXJ2aWNlLmNvbWJvYm94ID0gdGhpcztcbiAgICAvLyB0aGlzLnNlcnZpY2Uub3BlbkNoYW5nZSA9IHRoaXMub3BlbkNoYW5nZTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy5zZWxlY3Rpb24pIHtcbiAgICAgIHRoaXMuY2FsY3VsYXRlRGlzcGxheVZhbHVlKCk7XG4gICAgfVxuICB9XG5cbiAgb25BdHRhY2goKSB7XG4gICAgLy8gU2FtZSB3aWR0aCBhcyB0aGUgdHJpZ2dlciBlbGVtZW50XG4gICAgdGhpcy5vdmVybGF5V2lkdGggPSB0aGlzLm92ZXJsYXlPcmlnaW4uZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoO1xuICAgIHRoaXMuY2QuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgdGhpcy5rZXlNYW5hZ2VyID0gbmV3IEFjdGl2ZURlc2NlbmRhbnRLZXlNYW5hZ2VyKHRoaXMub3B0aW9ucykud2l0aFdyYXAoKTtcblxuICAgIC8vIEFjdGl2YXRlIHNlbGVjdGVkIGl0ZW0gb3IgZmlyc3Qgb3B0aW9uXG4gICAgY29uc3Qgc2VsZWN0ZWRPcHRpb24gPSB0aGlzLm9wdGlvbnMuZmluZChvID0+IG8uc2VsZWN0ZWQpO1xuICAgIGlmIChzZWxlY3RlZE9wdGlvbikge1xuICAgICAgdGhpcy5rZXlNYW5hZ2VyLnNldEFjdGl2ZUl0ZW0oc2VsZWN0ZWRPcHRpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmtleU1hbmFnZXIuc2V0Rmlyc3RJdGVtQWN0aXZlKCk7XG4gICAgfVxuXG4gICAgLy8gTGlzdGVuIHRvIGJ1dHRvbiBwcmVzc2VzIGlmIHBpY2tsaXN0IHRvIGFjdGl2YXRlIG1hdGNoaW5nIG9wdGlvblxuICAgIHRoaXMua2V5Ym9hcmRTdWJzY3JpYmUodGhpcy52YXJpYW50ID09PSAnYmFzZScpO1xuXG4gICAgLy8gV2hlbiBpdCBpcyBvcGVuIHdlIGxpc3RlbiBmb3Igb3B0aW9uIGNoYW5nZXMgaW4gb3JkZXIgdG8gZml4IGFjdGl2ZSBvcHRpb24gYW5kIGhhbmRsZSBzY3JvbGxcbiAgICB0aGlzLm9wdGlvbkNoYW5nZXNTdWJzY3JpcHRpb24gPSB0aGlzLm9wdGlvbnMuY2hhbmdlcy5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgaWYgKCF0aGlzLmFjdGl2ZU9wdGlvbiB8fCB0aGlzLm9wdGlvbnMudG9BcnJheSgpLmluZGV4T2YodGhpcy5hY3RpdmVPcHRpb24pID09PSAtMSkge1xuICAgICAgICAvLyBBY3RpdmF0ZSBmaXJzdCBvcHRpb24gaWYgYWN0aXZlIG9uZSBpcyBkZXN0cm95ZWRcbiAgICAgICAgdGhpcy5rZXlNYW5hZ2VyLnNldEZpcnN0SXRlbUFjdGl2ZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5hY3RpdmVPcHRpb24uc2Nyb2xsSW50b1ZpZXcoKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy51cGRhdGVNZW51SGVpZ2h0KCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnVwZGF0ZU1lbnVIZWlnaHQoKTtcbiAgfVxuXG4gIG9uRGV0YWNoKCkge1xuICAgIGlmICh0aGlzLm9wZW4pIHtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBDbGVhciBhcmlhLWFjdGl2ZWRlc2NlbmRhbnQgd2hlbiBtZW51IGlzIGNsb3NlZFxuICAgIHRoaXMuaW5wdXRFbC5zZXRBcmlhQWN0aXZlRGVzY2VuZGFudChudWxsKTtcblxuICAgIHRoaXMuZGV0YWNoKCk7XG4gIH1cblxuICB0cmFja0J5T3B0aW9uKGluZGV4LCBvcHRpb246IE5nbENvbWJvYm94T3B0aW9uKSB7XG4gICAgcmV0dXJuIG9wdGlvbi52YWx1ZTtcbiAgfVxuXG4gIGRyb3Bkb3duQ2xhc3MoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIFtgc2xkcy1kcm9wZG93bl9sZW5ndGgtJHt0aGlzLnZpc2libGVMZW5ndGh9YF06IHRoaXMudmlzaWJsZUxlbmd0aCA+IDAsXG4gICAgfTtcbiAgfVxuXG4gIGlucHV0SWNvblJpZ2h0KCkge1xuICAgIHJldHVybiB0aGlzLmlzTG9va3VwID8gJ3V0aWxpdHk6c2VhcmNoJyA6ICd1dGlsaXR5OmRvd24nO1xuICB9XG5cbiAgaGFzTm9NYXRjaGVzKCkge1xuICAgIHJldHVybiB0aGlzLmlzTG9va3VwICYmIHRoaXMuZGF0YS5sZW5ndGggPT09IDAgJiYgIXRoaXMubG9hZGluZ01vcmU7XG4gIH1cblxuICBvbk9wdGlvblNlbGVjdGlvbihvcHRpb246IE5nbENvbWJvYm94T3B0aW9uID0gdGhpcy5hY3RpdmVPcHRpb24pIHtcbiAgICBjb25zdCBzZWxlY3Rpb24gPSBhZGRPcHRpb25Ub1NlbGVjdGlvbihvcHRpb24udmFsdWUsIHRoaXMuc2VsZWN0aW9uLCB0aGlzLm11bHRpcGxlKTtcbiAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZS5lbWl0KHNlbGVjdGlvbik7XG4gICAgaWYgKHRoaXMuY2xvc2VPblNlbGVjdGlvbikge1xuICAgICAgdGhpcy5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8vIFRyaWdnZXIgYnkgY2xlYXIgYnV0dG9uIG9uIExvb2t1cFxuICBvbkNsZWFyU2VsZWN0aW9uKCkge1xuICAgIHRoaXMuc2VsZWN0aW9uQ2hhbmdlLmVtaXQobnVsbCk7XG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmlucHV0RWwuZm9jdXMoKSwgMCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgd2hldGhlciB2YWx1ZSBpcyBjdXJyZW50bHkgc2VsZWN0ZWQuXG4gICAqXG4gICAqIEBwYXJhbSB2YWx1ZSBUaGUgdmFsdWUgaW4gdGVzdCwgd2hldGhlciBpcyAocGFydCBvZikgc2VsZWN0aW9uIG9yIG5vdFxuICAgKi9cbiAgaXNTZWxlY3RlZCh2YWx1ZTogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGlzT3B0aW9uU2VsZWN0ZWQodmFsdWUsIHRoaXMuc2VsZWN0aW9uLCB0aGlzLm11bHRpcGxlKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGV0YWNoKCk7XG4gIH1cblxuICBjbG9zZSgpIHtcbiAgICB0aGlzLm9wZW5DaGFuZ2UuZW1pdChmYWxzZSk7XG4gIH1cblxuICBwcml2YXRlIGRldGFjaCgpIHtcbiAgICB0aGlzLmtleWJvYXJkU3Vic2NyaWJlKGZhbHNlKTtcbiAgICB0aGlzLmtleU1hbmFnZXIgPSBudWxsO1xuICAgIGlmICh0aGlzLm9wdGlvbkNoYW5nZXNTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMub3B0aW9uQ2hhbmdlc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgdGhpcy5vcHRpb25DaGFuZ2VzU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZURpc3BsYXlWYWx1ZSgpIHtcbiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuc2VsZWN0aW9uVmFsdWVGbih0aGlzLnNlbGVjdGVkT3B0aW9ucy5tYXAob3B0aW9uID0+IG9wdGlvbi5sYWJlbCkpO1xuICAgIHRoaXMuaW5wdXRFbC5zZXRWYWx1ZSh2YWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIGtleWJvYXJkU3Vic2NyaWJlKGxpc3RlbjogYm9vbGVhbikge1xuICAgIGlmICh0aGlzLmtleWJvYXJkU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLmtleWJvYXJkU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICB0aGlzLmtleWJvYXJkU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAobGlzdGVuKSB7XG4gICAgICB0aGlzLmtleWJvYXJkU3Vic2NyaXB0aW9uID0gdGhpcy5pbnB1dEVsLmtleWJvYXJkQnVmZmVyJC5zdWJzY3JpYmUoKHBhdHRlcm4pID0+IHtcbiAgICAgICAgcGF0dGVybiA9IHBhdHRlcm4udG9Mb2NhbGVMb3dlckNhc2UoKTtcblxuICAgICAgICBjb25zdCBvcHRpb25zID0gdGhpcy5vcHRpb25zLnRvQXJyYXkoKTtcblxuICAgICAgICBjb25zdCBhY3RpdmVJbmRleCA9IHRoaXMuYWN0aXZlT3B0aW9uID8gdGhpcy5rZXlNYW5hZ2VyLmFjdGl2ZUl0ZW1JbmRleCArIDEgOiAwO1xuICAgICAgICBmb3IgKGxldCBpID0gMCwgbiA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7XG4gICAgICAgICAgY29uc3QgaW5kZXggPSAoYWN0aXZlSW5kZXggKyBpKSAlIG47XG4gICAgICAgICAgY29uc3Qgb3B0aW9uID0gb3B0aW9uc1tpbmRleF07XG4gICAgICAgICAgaWYgKCFvcHRpb24uZGlzYWJsZWQgJiYgb3B0aW9uLmxhYmVsLnRvTG9jYWxlTG93ZXJDYXNlKCkuc3Vic3RyKDAsIHBhdHRlcm4ubGVuZ3RoKSA9PT0gcGF0dGVybikge1xuICAgICAgICAgICAgdGhpcy5rZXlNYW5hZ2VyLnNldEFjdGl2ZUl0ZW0ob3B0aW9uKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVNZW51SGVpZ2h0KCkge1xuICAgIHRoaXMubmdab25lLm9uU3RhYmxlLmFzT2JzZXJ2YWJsZSgpLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIGNvbnN0IHsgb3ZlcmxheVJlZiB9ID0gdGhpcy5jZGtPdmVybGF5O1xuICAgICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5kcm9wZG93bkVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHQ7XG4gICAgICBvdmVybGF5UmVmLnVwZGF0ZVNpemUoe1xuICAgICAgICBtaW5IZWlnaHQ6IGhlaWdodCArIDQsXG4gICAgICB9KTtcbiAgICAgIG92ZXJsYXlSZWYudXBkYXRlUG9zaXRpb24oKTtcbiAgICB9KTtcbiAgfVxufVxuIl19